# 实时消息推送系统

| 组件    | 作用                                                           |
| ------- | -------------------------------------------------------------- |
| Hub     | 管理客户端连接（WebSocket/长轮询），负责用户在线状态查询       |
| MySQL   | 存储用户状态信息和消息持久化，支持历史消息查询和重加载         |
| Redis   | 临时消息缓存，提高读写性能，减轻数据库压力                     |
| Kafka   | 消息总线，用于跨实例消息广播和通信                             |
| etcd    | 扩展功能：多实例服务注册/发现、分布式锁、全局配置              |


## 消息流

1. 客户端注册
   - 客户端通过 /api/v1/ws 建立 WebSocket 连接（带 JWT 验证），注册到 Hub。
   - 若 WebSocket 不可用，客户端回退到 /api/v1/longpoll 进行 HTTP 长轮询。
   - Hub 将用户连接状态信息更新到 MySQL 数据库。

2. 消息入口
   - 外部系统调用 /api/v1/push，服务端接收消息并封装。
   - 消息同时写入 MySQL 进行持久化存储和 Kafka topic 用于跨实例广播。

3. 消息消费与路由
   - 推送服务作为 Kafka consumer，从 topic 中消费消息。
   - 根据目标用户状态（MySQL 中查询用户是否在线）：
     - 在线：通过对应实例的 Hub 直接推送 WebSocket 消息。
     - 离线：消息已持久化在 MySQL 中，同时写入 Redis 缓存队列（提高读取性能）。

4. 客户端重连/消息补偿
   - 客户端重连时，Hub 先从 Redis 缓存队列获取未读消息并推送。
   - 如果 Redis 中没有对应消息或需要更多历史消息，则从 MySQL 数据库中查询并推送。


## 注意

1. 实例内部：Hub 连接管理，MySQL 状态存储
   - Hub：
     - 管理本机用户连接（WebSocket/长轮询）。
     - 负责查询用户在线状态（通过 MySQL）。
     - 负责消息下发。

   - MySQL：
     - 存储用户状态信息（在线/离线、所属实例等）。
     - 持久化存储所有消息，支持历史消息查询。
     - 提供消息重加载功能。

   - Redis（临时缓存）：
     - 缓存热点消息，提高读写性能。
     - 减轻数据库压力。

2. 实例之间
   - MySQL：
     - 存储用户路由信息：user:123 → instance-1（用户在哪个实例连接）。
     - 存储所有消息记录，支持跨实例消息查询。

   - Kafka："消息总线"，主要用于实例间通信：
     - 作为消息总线：外部系统 push → 写 Kafka → 所有推送服务实例消费。
     - 作为跨实例转发的桥梁：消息写入 Kafka，由所有实例消费，只有目标实例 Hub 才推送。


## 技术实现与流程

系统采用了分层架构设计：

1. 连接层
   - Hub组件管理本机内存中的客户端连接
   - 支持WebSocket和HTTP长轮询两种连接方式
   - 客户端通过JWT验证进行身份认证
2. 消息流转
   - 外部系统通过REST API发送消息到服务端
   - 消息被封装后写入Kafka作为消息总线
   - 推送服务作为消费者从Kafka获取消息并进行路由
3. 消息路由
   - 在线用户：直接通过Hub推送WebSocket消息
   - 离线用户：消息写入Redis缓存队列
   - 跨实例通信：通过Kafka作为桥梁实现
4. 消息补偿机制
   - 短期离线：从Redis获取未读消息
   - 长期离线：从Kafka按offset拉取历史消息


## 扩展性

1. 水平扩展
   - Kafka：解耦消息生产与消费，支撑多实例水平扩展。
   - Redis Cluster：存储用户在线状态、短期离线消息（缓存层）。
   - Hub：仅管理本实例的连接（本地用户 <-> 消息推送）。
   - Nginx/负载均衡：WebSocket 请求分发，支持 ip_hash / sticky session，或单独做一层连接路由服务。
2. 高可用
   - Kafka：多分区 + 三副本，保证消息持久化。
   - Redis：Cluster 模式 + AOF/RDB 持久化，用于短期消息与状态缓存。
   - 服务实例：健康检查 + 自动扩缩容。
3. 性能与可靠性
   - Redis 短期消息队列：LPUSH + LTRIM 控制队列长度，避免无限膨胀。
   - 长期消息查询：基于 Kafka offset 回溯。
   - Push API 限流、熔断，客户端连接数限制。
   - 心跳与超时检测：连接断开后清理 Redis 状态，并触发离线逻辑。
4. 安全
   - 客户端鉴权：JWT 签发与过期策略。
   - 服务间通信：Service token / RBAC。
   - 管理接口：请求签名 + IP 白名单。
   - 外部接入：Nginx 边界代理，TLS 终止。


## 未来改进建议

1. 实时协作功能扩展
   - 增加共享白板、文档协作等实时互动功能
   - 实现基于WebRTC的音视频通话集成
2. 智能消息分发
   - 引入机器学习算法对消息进行优先级排序
   - 根据用户行为和偏好智能推送重要消息
3. 多端同步与状态一致性
   - 实现设备间阅读状态同步
   - 添加端到端加密保障消息安全
4. 高级房间功能
   - 支持临时房间和永久房间
   - 添加房间权限管理和角色系统
   - 实现房间搜索和推荐功能
5. 消息富媒体支持
   - 增强对图片、视频、文件等多媒体内容的支持
   - 添加消息编辑和撤回功能
6. 分布式追踪与监控
   - 集成OpenTelemetry进行全链路追踪
   - 实现消息传递的可视化监控