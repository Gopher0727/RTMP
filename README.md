# 实时消息推送系统

| 组件  | 作用                                                           |
| ----- | -------------------------------------------------------------- |
| Hub   | 本机内存管理客户端连接（WebSocket/长轮询），负责消息下发。     |
| Redis | 缓存短期离线消息 + 本地用户路由（user → instance），快速回溯。 |
| Kafka | 消息总线 + 长期持久化 + 跨实例消息广播。                       |
| etcd  | 扩展功能：多实例服务注册/发现、分布式锁、全局配置。            |


## 消息流

1. 客户端注册
   - 客户端通过 /api/v1/ws 建立 WebSocket 连接（带 JWT 验证），注册到 Hub。
   - 若 WebSocket 不可用，客户端回退到 /api/v1/longpoll 进行 HTTP 长轮询。

2. 消息入口
   - 外部系统调用 /api/v1/push，服务端接收消息并封装后写入 Kafka topic（Kafka 作为消息总线与持久化存储）。

3. 消息消费与路由
   - 推送服务作为 Kafka consumer，从 topic 中消费消息。
   - 根据目标用户状态（Hub 是否有连接）：
     - 在线：通过本实例 Hub 直接推送 WebSocket 消息。
     - 离线：消息先写入 Redis 缓存队列（短期存放 + 快速回溯）。Kafka 作为 长期存储，支持历史消息回退（例如客户端要求同步 7 天内消息）。

4. 客户端重连/消息补偿
   - 客户端重连时，Hub 拉取该用户在 Redis 缓存队列里的未读消息并推送，之后清理缓存。
   - 如果 Redis 中没有对应消息（过期/被裁剪），则从 Kafka 历史消息中按 offset 拉取进行补偿。


## 注意

1. 实例内部：Hub 内存为主，Redis 缓存兜底
   - Hub（本地内存）：
     - 保存本机用户连接（WebSocket/长轮询）。
     - Hub 直接负责消息下发，不需要 Kafka/Redis。

   - Redis（可选，本地缓存/短期队列）：
     - 保存本机的离线消息，或者临时存储用户 session。
     - 如果用户短暂掉线（几分钟），重连时可以从 Redis 拿消息。

2. 实例之间
   - Redis
     - 存用户路由信息：user:123 → instance-1（用户在哪个实例连接）。
     - 存短期离线消息：用户离线时，消息先写到 Redis List/Stream。用户在 1 分钟内重连，就从 Redis 拉取。

   - Kafka：“消息总线”，主要用于实例间传递和持久化。
     - 作为消息总线（主通道）：外部系统 push → 写 Kafka → 所有推送服务实例消费。
     - 作为长期存储：消息保留 7 天/30 天，用户需要回溯时，可以从 Kafka offset 拉取。
     - 作为跨实例转发的桥梁（如果不用 Redis 做路由直查）：消息写入 Kafka，由所有实例消费，只有目标实例 Hub 才推送。


## 扩展性

1. 水平扩展
   - Kafka：解耦消息生产与消费，支撑多实例水平扩展。
   - Redis Cluster：存储用户在线状态、短期离线消息（缓存层）。
   - Hub：仅管理本实例的连接（本地用户 <-> 消息推送）。
   - Nginx/负载均衡：WebSocket 请求分发，支持 ip_hash / sticky session，或单独做一层连接路由服务。
2. 高可用
   - Kafka：多分区 + 三副本，保证消息持久化。
   - Redis：Cluster 模式 + AOF/RDB 持久化，用于短期消息与状态缓存。
   - 服务实例：健康检查 + 自动扩缩容。
3. 性能与可靠性
   - Redis 短期消息队列：LPUSH + LTRIM 控制队列长度，避免无限膨胀。
   - 长期消息查询：基于 Kafka offset 回溯。
   - Push API 限流、熔断，客户端连接数限制。
   - 心跳与超时检测：连接断开后清理 Redis 状态，并触发离线逻辑。
4. 安全
   - 客户端鉴权：JWT 签发与过期策略。
   - 服务间通信：Service token / RBAC。
   - 管理接口：请求签名 + IP 白名单。
   - 外部接入：Nginx 边界代理，TLS 终止。
